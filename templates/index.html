<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Dashboard de Empresas por Cidade e Natureza Juridica</title>

<style>
:root {
    --primary:#2c3e50;
    --secondary:#3498db;
    --light:#ecf0f1;
    --dark:#2c3e50;
    --danger:#e74c3c;
    --border:#ddd;
    --shadow:rgba(0,0,0,.05);
    --white:#fff;
}

body {
    margin:0;
    font-family:Segoe UI,Tahoma,sans-serif;
    background:#f5f7fa;
}

/* ===== LAYOUT ===== */
.app {
    display:flex;
    height:100vh;
    overflow:hidden;
}

.sidebar {
    width:320px;
    background:var(--white);
    border-right:1px solid var(--border);
    box-shadow:2px 0 8px var(--shadow);
    display:flex;
    flex-direction:column;
}

.sidebar-header {
    background:var(--primary);
    color:#fff;
    padding:14px;
}

.sidebar-header h1 {
    font-size:1.2em;
    margin:0;
}

.sidebar-header p {
    margin:4px 0 0;
    font-size:.9em;
}

.sidebar-content {
    padding:12px;
    overflow-y:auto;
}

/* Toggle mobile */
.toggle-filters {
    display:none;
    background:var(--secondary);
    color:#fff;
    border:none;
    padding:10px;
    font-size:14px;
    width:100%;
    cursor:pointer;
}

/* ===== FILTROS ===== */
.search-box {
    display:flex;
    gap:8px;
    position:relative;
}

input {
    flex:1;
    padding:10px;
    border:2px solid var(--border);
    border-radius:6px;
}

button {
    background:var(--secondary);
    border:none;
    color:#fff;
    padding:10px 14px;
    border-radius:6px;
    cursor:pointer;
}

.filter-buttons {
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    margin-top:10px;
}

.filter-btn {
    background:var(--light);
    border:1px solid var(--border);
    padding:6px 10px;
    font-size:12px;
    border-radius:14px;
    cursor:pointer;
}

.filter-btn.danger {
    background:var(--danger);
    color:#fff;
}

/* ===== MAIN ===== */
.main {
    flex:1;
    display:flex;
    flex-direction:column;
}

.results {
    flex:1;
    overflow:auto;
    padding:12px;
}

table {
    width:100%;
    border-collapse:collapse;
    background:#fff;
}

th,td {
    padding:10px;
    border-bottom:1px solid var(--border);
    font-size:.85em;
}

th {
    background:var(--light);
}

/* ===== AUTOCOMPLETE ===== */
.autocomplete {
    position:absolute;
    top:100%;
    left:0;
    right:0;
    background:#fff;
    border:1px solid var(--border);
    max-height:200px;
    overflow-y:auto;
    display:none;
    z-index:10;
}

.autocomplete-item {
    padding:8px;
    cursor:pointer;
}

.autocomplete-item:hover {
    background:var(--light);
}

/* ===== MOBILE ===== */
@media(max-width:900px){
    .sidebar {
        position:absolute;
        z-index:20;
        left:-100%;
        transition:left .3s;
        width:100%;
    }
    .sidebar.open {
        left:0;
    }
    .toggle-filters {
        display:block;
    }
}
</style>
</head>

<body>

<button class="toggle-filters" onclick="toggleSidebar()">üîç Filtros</button>

<div class="app">

<!-- SIDEBAR -->
<aside class="sidebar" id="sidebar">

<div class="sidebar-header">
    <h1>Dashboard de Empresas</h1>
    <p>Filtros avan√ßados</p>
</div>

<div class="sidebar-content">

<div class="search-box">
    <input id="city-input" placeholder="Cidade...">
    <button onclick="buscarCidade()">Buscar</button>
    <div class="autocomplete" id="autocomplete-list"></div>
</div>

<div class="filter-buttons">
    <div class="filter-btn" onclick="buscarCidadePorNome('Sao Paulo')">S√£o Paulo</div>
    <div class="filter-btn" onclick="buscarCidadePorNome('Rio de Janeiro')">Rio De Janeiro</div>
    <div class="filter-btn" onclick="buscarCidadePorNome('Belem')">Bel√©m</div>
    <div class="filter-btn" onclick="buscarCidadePorNome('Salvador')">Salvador (BA)</div> 
    <div class="filter-btn" onclick="buscarCidadePorNome('Fortaleza')">Fortaleza (CE)</div> 
    <div class="filter-btn" onclick="buscarCidadePorNome('Recife')">Recife (PE)</div> 
    <div class="filter-btn" onclick="buscarCidadePorNome('Porto Alegre')">Porto Alegre (RS)</div> 
    <div class="filter-btn" onclick="buscarCidadePorNome('Manaus')">Manaus (AM)</div> 
    <div class="filter-btn" onclick="buscarCidadePorNome('Brasilia')">Brasilia (DF)</div> <div class="filter-btn" onclick="buscarCidadePorNome('Curitiba')">Curitiba (PR)</div> <div class="filter-btn" onclick="buscarCidadePorNome('Belo Horizonte')">Belo Horizonte (MG)</div>
</div>

<hr>

<div class="filter-buttons">
    <div class="filter-btn" onclick="filtrarPorNatureza('Sociedade Empres√°ria Limitada')">Sociedade Empres√°ria Limitada</div> 
    <div class="filter-btn" onclick="filtrarPorNaturezaParcial('Sociedade An√¥nima')">Sociedade An√¥nima</div> 
    <div class="filter-btn" onclick="filtrarPorNatureza('Empres√°rio (Individual)')">Empres√°rio (Individual)</div> 
    <div class="filter-btn" onclick="filtrarPorNatureza('Cooperativa')">Cooperativa</div> 
    <div class="filter-btn" onclick="filtrarPorNatureza('Empresa P√∫blica')">Empresa P√∫blica</div> 
    <div class="filter-btn" onclick="filtrarPorNaturezaParcial('Sociedade Simples')">Sociedade Simples (todos)</div> 
    <div class="filter-btn" onclick="filtrarPorNatureza('Sociedade Simples Pura')">Sociedade Simples Pura</div> 
    <div class="filter-btn" onclick="filtrarPorNatureza('Sociedade Simples Limitada')">Sociedade Simples Limitada</div> 
    <div class="filter-btn" onclick="filtrarPorNatureza('Sociedade Simples em Nome Coletivo')">Sociedade Simples em Nome Coletivo</div>
</div>

<hr>

<div class="filter-buttons">
    <div class="filter-btn danger" onclick="limparFiltros()">üóë Limpar</div>
</div>

</div>
</aside>

<!-- MAIN -->
<main class="main">
<div class="results" id="results-container">

<h2 id="city-title">Empresas em <span id="city-name">...</span></h2>
<div id="city-message"></div>

<table>
<thead>
<tr>
<th>CNPJ</th><th>Raz√£o</th><th>Fantasia</th><th>UF</th><th>Munic√≠pio</th>
</tr>
</thead>
<tbody id="city-body"></tbody>
</table>

<div style="text-align:center;margin:12px">
<button id="load-more-btn" onclick="carregarMais()" style="display:none">‚¨áÔ∏è Carregar mais</button>
</div>

</div>
</main>

</div>

    <script>
    let cidadeAtual = '';
    let naturezaAtual = '';
    let usarFiltroParcial = false;
    let offsetAtual = 0;
    let totalCarregado = 0;
    let temMais = true; // assume que h√° mais at√© provar o contr√°rio

    // --- Autocomplete ---
    document.getElementById('city-input').addEventListener('input', function() {
        const termo = this.value.trim();
        const autocomplete = document.getElementById('autocomplete-list');
        autocomplete.style.display = 'none';

        if (termo.length < 2) return;

        fetch(`/api/cidades/?q=${encodeURIComponent(termo)}`)
            .then(response => response.json())
            .then(cidades => {
                autocomplete.innerHTML = '';
                if (cidades.length > 0) {
                    cidades.forEach(cidade => {
                        const div = document.createElement('div');
                        div.className = 'autocomplete-item';
                        div.textContent = cidade.label;
                        div.onclick = () => {
                            document.getElementById('city-input').value = cidade.value;
                            autocomplete.style.display = 'none';
                            aplicarFiltros(cidade.value, naturezaAtual, usarFiltroParcial);
                        };
                        autocomplete.appendChild(div);
                    });
                    autocomplete.style.display = 'block';
                }
            })
            .catch(() => autocomplete.style.display = 'none');
    });

    document.addEventListener('click', function(e) {
        if (!e.target.closest('.search-box')) {
            document.getElementById('autocomplete-list').style.display = 'none';
        }
    });

    // --- Fun√ß√µes principais ---
    function buscarCidade() {
        const nome = document.getElementById('city-input').value.trim();
        if (!nome) {
            alert("Digite o nome de uma cidade");
            return;
        }
        aplicarFiltros(nome, naturezaAtual, usarFiltroParcial);
    }

    function buscarCidadePorNome(cidade) {
        aplicarFiltros(cidade, naturezaAtual, usarFiltroParcial);
    }

    function filtrarPorNatureza(natureza) {
        usarFiltroParcial = false;
        aplicarFiltros(cidadeAtual, natureza, false);
    }

    function filtrarPorNaturezaParcial(natureza) {
    usarFiltroParcial = true;
    // Remove "(todos)" se existir
    const naturezaLimpa = natureza.replace(/\s*\(todos\)$/i, '');
    aplicarFiltros(cidadeAtual, naturezaLimpa, true);
}

    function limparFiltros() {
        cidadeAtual = '';
        naturezaAtual = '';
        usarFiltroParcial = false;
        offsetAtual = 0;
        document.getElementById('city-input').value = '';
        mostrarTabelaVazia();
        document.getElementById('load-more-btn').style.display = 'none';
    }

    function aplicarFiltros(cidade, natureza, isParcial) {
        cidadeAtual = cidade || '';
        naturezaAtual = natureza || '';
        usarFiltroParcial = !!isParcial;
        offsetAtual = 0; // reset offset ao aplicar novo filtro
        temMais = true;

        if (cidade) {
            document.getElementById('city-input').value = cidade;
        }

        mostrarLoading();
        carregarResultados();
    }

    function carregarMais() {
        if (!temMais) return;
        offsetAtual += 100;
        carregarResultados(true); // true = append
    }

    function carregarResultados(append = false) {
        let url = '';
        if (cidadeAtual && naturezaAtual) {
            if (usarFiltroParcial) {
                url = `/api/cidade/${encodeURIComponent(cidadeAtual)}/natureza/partial/${encodeURIComponent(naturezaAtual)}/`;
            } else {
                url = `/api/cidade/${encodeURIComponent(cidadeAtual)}/natureza/${encodeURIComponent(naturezaAtual)}/`;
            }
        } else if (cidadeAtual) {
            url = `/api/cidade/${encodeURIComponent(cidadeAtual)}/`;
        } else if (naturezaAtual) {
            if (usarFiltroParcial) {
                url = `/api/natureza/partial/${encodeURIComponent(naturezaAtual)}/`;
            } else {
                url = `/api/natureza/${encodeURIComponent(naturezaAtual)}/`;
            }
        } else {
            mostrarTabelaVazia();
            return;
        }

        // Adiciona offset
        const separator = url.includes('?') ? '&' : '?';
        url += `${separator}offset=${offsetAtual}`;

        fetch(url)
            .then(response => {
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return response.json();
            })
            .then(empresas => {
                if (!append) {
                    // Primeira carga
                    if (cidadeAtual && naturezaAtual) {
                        let titulo = `${cidadeAtual} ‚Äî ${naturezaAtual}`;
                        if (usarFiltroParcial) titulo += ' (todos)';
                        document.getElementById('city-name').textContent = titulo;
                    } else if (cidadeAtual) {
                        document.getElementById('city-name').textContent = cidadeAtual;
                    } else if (naturezaAtual) {
                        let titulo = `Natureza Jur√≠dica: ${naturezaAtual}`;
                        if (usarFiltroParcial) titulo += ' (todos)';
                        document.getElementById('city-name').textContent = titulo;
                    }
                    document.getElementById('city-message').innerHTML = '';
                    document.getElementById('city-body').innerHTML = '';
                }

                if (empresas.length === 0) {
                    temMais = false;
                    if (!append && offsetAtual === 0) {
                        let msg = 'Nenhuma empresa encontrada.';
                        if (cidadeAtual && naturezaAtual) {
                            msg = `Nenhuma empresa em "${cidadeAtual}" com natureza ${usarFiltroParcial ? 'contendo' : 'exatamente'}: "${naturezaAtual}"`;
                        } else if (cidadeAtual) {
                            msg = `Nenhuma empresa encontrada em "${cidadeAtual}"`;
                        } else if (naturezaAtual) {
                            msg = `Nenhuma empresa com natureza ${usarFiltroParcial ? 'contendo' : 'exatamente'}: "${naturezaAtual}"`;
                        }
                        document.getElementById('city-message').innerHTML = `<div class="error">${msg}</div>`;
                    }
                    document.getElementById('load-more-btn').style.display = 'none';
                    return;
                }

                // Adiciona ao tbody
                const tbody = document.getElementById('city-body');
                empresas.forEach(emp => {
                    const safe = val => val || '‚Äì';
                    const tel = emp.telefone1 || emp.telefone2 || '‚Äì';
                    const email = emp.correio_eletronico || '‚Äì';
                    const capital = emp.capital_social ?
                        `R$ ${parseFloat(emp.capital_social).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` :
                        '‚Äì';

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${safe(emp.cnpj_basico)}</td>
                        <td>${safe(emp.razao_social)}</td>
                        <td>${safe(emp.nome_fantasia)}</td>
                        <td>${safe(emp.porte_empresa)}</td>
                        <td>${capital}</td>
                        <td>${safe(emp.uf)}</td>
                        <td>${safe(emp.municipio)}</td>
                        <td>${safe(emp.logradouro)}</td>
                        <td>${safe(emp.numero)}</td>
                        <td>${safe(emp.bairro)}</td>
                        <td class="cep">${safe(emp.cep)}</td>
                        <td class="telefone">${tel}</td>
                        <td class="email">${email}</td>
                    `;
                    tbody.appendChild(row);
                });

                // Mostra ou esconde o bot√£o "Carregar mais"
              if (!append && empresas.length < 100) {
    temMais = false;
    document.getElementById('load-more-btn').style.display = 'none';
} else {
    temMais = true; // Assume que h√° mais
    document.getElementById('load-more-btn').style.display = 'block';
}
            })
            .catch(error => {
                console.error("Erro:", error);
                if (!append) {
                    document.getElementById('city-message').innerHTML = `<div class="error">Erro ao carregar empresas.</div>`;
                }
                document.getElementById('load-more-btn').style.display = 'none';
            });
    }

    function mostrarLoading() {
        document.getElementById('results-container').style.display = 'block';
        document.getElementById('city-message').innerHTML = '<div class="loading">Buscando empresas...</div>';
        document.getElementById('load-more-btn').style.display = 'none';
    }

    function mostrarTabelaVazia() {
        document.getElementById('city-name').textContent = '...';
        document.getElementById('city-message').innerHTML = '<div style="text-align:center; padding:20px; color:#7f8c8d;">Nenhum filtro aplicado. Selecione uma cidade ou natureza jur√≠dica.</div>';
        document.getElementById('city-body').innerHTML = '';
        document.getElementById('load-more-btn').style.display = 'none';
    }
    function toggleSidebar(){
    document.getElementById('sidebar').classList.toggle('open');
}

// Persist√™ncia na URL
function syncURL(){
    const params = new URLSearchParams();
    if(cidadeAtual) params.set('cidade', cidadeAtual);
    if(naturezaAtual) params.set('natureza', naturezaAtual);
    if(usarFiltroParcial) params.set('parcial','1');
    history.replaceState(null,'','?'+params.toString());
}

// Hook autom√°tico
const _aplicarFiltros = aplicarFiltros;
aplicarFiltros = function(...args){
    _aplicarFiltros(...args);
    syncURL();
}

// Load inicial
window.onload = () => {
    const p = new URLSearchParams(location.search);
    if(p.get('cidade')){
        aplicarFiltros(
            p.get('cidade'),
            p.get('natureza') || '',
            p.get('parcial') === '1'
        );
    } else {
        mostrarTabelaVazia();
    }
};
</script>
</body>
</html>